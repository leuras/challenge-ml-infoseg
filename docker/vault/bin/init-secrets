#!/bin/sh

__attempts=1

echo "Trying to login to Vault instance ..."
while [ $__attempts -le 10 ]; do
    echo "Attempt ${__attempts} ..."

    __logged_in=$(vault login "${VAULT_TOKEN}" 2> /dev/null)
    if [ ! -z "${__logged_in}" ]; then
        echo "Logged in to Vault successfully!"
        break
    fi;

    sleep 3
    __attempts=$((__attempts+1)) 
done

# Creates the db secret entry for all services
for __service_name in "customer-data-service" "purchase-service" "payment-data-service"
do
    echo "Trying to initialize the db secrets for ${__service_name} ..."

    vault kv put "secret/${__service_name}/db" \
    DB_USER=${RO_DB_USER} \
    DB_PASS=${RO_DB_PASS}
done

# customer-data-service
echo "Trying to initialize the app secrets for customer-data-service ..."
vault kv put secret/customer-data-service/app \
    FOO=BAR

# purchase-service
echo "Trying to initialize the app secrets for purchase-service ..."
vault kv put secret/purchase-service/app \
    FOO=BAR

# payment-data-service
echo "Trying to initialize secrets for payment-data-service ..."
vault kv put secret/payment-data-service/app \
    FOO=BAR

# supplier-service
echo "Trying to initialize the app secrets for supplier-service ..."
vault kv put secret/supplier-service/db \
    DB_USER=${DDL_DB_USER} \
    DB_PASS=${DDL_DB_PASS}

unset RO_DB_USER RO_DB_PASS DDL_DB_USER DDL_DB_PASS